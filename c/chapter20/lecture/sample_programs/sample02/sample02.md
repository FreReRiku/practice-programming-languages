# sample02.md

## 分割の定石

### 変数の共有

前節では、最低限の構成でプログラムを複数ファイルに分割しました。
しかし、共有できたのは関数だけであり、変数の共有は行いませんでした。

複数のソースファイルに分けて開発を行う場合は、
関数だけでなく、変数や定数なども共有する必要が生じてきますが、
前章の方法では、変数を共有することはできません。

たとえば、次のようにヘッダーファイル内で変数を宣言すると、
宣言が重複している、という意味のエラーが表示され、コンパイル出来ません。

```h
/* sum.h */
int sum(int min, int max);
int Public;
```

このエラーをより正確に理解するには、宣言の意味を理解する必要があります。
これまで、関数にしろ変数にしろ、宣言する、と表現してきましたが、
実は、宣言には2種類の機能があります。

変数や関数の宣言を行うと、コンパイラがその名前と形を記憶します。
これが、宣言と呼ばれる機能です。
そして、同時に、コンパイラは実際に変数や関数を作成します。
これが、定義と呼ばれる機能です。
これまでの変数では、この宣言と定義を常に同時に行っていたのです。

宣言は、変数や関数の形をコンパイラに教えるだけなので、
その形さえ同じであれば、何回宣言しても問題ありません。
しかし、定義では、関数や関数の実体を作成することになります。
同じ関数や変数が何回も作られると区別がつかなくなるためエラーとなります。

#### プロトタイプ宣言なら

前章では、プロトタイプ宣言だけを記述して成功しましたが、
これは、プロトタイプ宣言は、宣言だけを行い、定義は行わないからです。
したがって、プロトタイプ宣言は(同じ書き方なら)いくつでも書けます。

### extern宣言

前項では、変数は宣言と定義を同時に行うため、複数回宣言できないことを説明しました。
この問題を解決するには、宣言だけを複数回行い、定義は1回で済ませる必要があります。
その場合、宣言だけを行うextern(エクスターン)宣言が用意されています。

#### キーワード

##### extern宣言

宣言だけを行い、定義は行わない宣言方法。

---

extern宣言の使い方は簡単です。
ただ、今までの宣言の前にexternと記述するだけです。
次のヘッダーファイルは、関数と変数に対してextern宣言を行っています。

```h
/* sum.h */
extern int sum(int min, int max);
extern int Public;  /* 変数のextern宣言 */
```

このextern宣言を使うと、異なるソースファイルで変数を共有することができます。
まずは、ヘッダーファイル内でなんらかの変数をextern宣言します。

これで、変数Publicはsum.hをインクルードしているすべてのソースファイルで共有できます。
しかし、これだけでは定義がされていないため、変数Publicはつくられていません。
そこで、どこか1つのソースファイルの中で普通の宣言を行って実体を作成します。

```c
/* sum.c */
int Public; /* 変数の実体の作成 */

int sum(int min, int max)
{
    int num;
    num = (min + max) * (max - min + 1) / 2;

    return num;
}
```

これで、変数Publicはmain.cからもsum.cからも使えるようになります。
次のプログラムは、それを実際に試してみた例です。

```c
/* main.c */

#include "sum.h"
#include <stdio.h>

int main(void)
{
    int value;
    value = sum(50, 100);
    printf("%d\n", Public);

    return 0;
}
```

#### 必要最低限に

変数の共有は大変便利なテクニックですが、あまり乱用しないでください。
本来、複数のファイルに分割するのは、機能ごとに独立させるためです。
しかし、変数の共有を使用すると、同じ変数が使えるようになってしまい、
機能毎に独立させる意味合いが薄れてしまいます。

したがって、可能な限り関数の引数や戻り値を利用し、
変数の共有は、どうしても必要な場合にのみ使用してください。

